# AI开发提示词：M3U8视频下载器篡改猴插件开发需求
## 嗅探
通过各种手段，嗅探各个站点是否m3u8资源，如果有，页面右上角弹出下载弹框，可选下载，可关闭。

## 一、项目核心目标
请基于Node.js开发一款高性能、支持断点续传的M3U8视频下载器，能够解析M3U8文件结构，多线程下载加密/非加密TS片段，自动解密并合并为完整视频文件，同时具备进度监控、状态保存与恢复功能。

## 二、技术栈与核心依赖
1. **核心模块**：必须基于Node.js内置模块开发，包括但不限于`fs`（含同步与异步API）、`path`、`url`、`crypto`、`worker_threads`、`http`、`https`、`readline`、`timers`。
2. **无第三方依赖**：不得使用外部npm包，所有功能通过内置模块实现。

## 三、核心功能需求
### 1. 命令行参数解析
- 支持两种运行模式：新下载模式、断点续传模式
- 必须支持的参数：
  - 新下载：`<m3u8-url>`（必填）、`-o/--output`（输出文件/文件夹路径，默认为根据url计算出的路径）、`--output-folder`（指定输出文件夹）、`-t/--threads`（下载线程数，默认5，没有极限）、`-r/--retries`（最大重试次数，默认30）、`--timeout`（默认超时时间设置为当前最慢下载片段时间*1.5，一开始为无穷大）
  - 续传模式：`--resume <临时目录>`（必填）、`--force-merge`（强制合并）
- 参数校验：若未提供`m3u8-url`且未指定续传目录，需输出使用说明并退出。

### 2. M3U8文件解析
- 验证文件合法性：必须以`#EXTM3U`开头，否则抛出错误
- 提取关键信息：
  - 媒体片段：解析`#EXTINF:`标签后的TS片段URL、时长，生成带索引的片段列表
  - 加密信息：解析`#EXT-X-KEY`标签，提取加密方法（如AES-128）、密钥URL、IV向量
  - 总时长：累加所有片段时长

### 3. 网络请求与下载
- 实现HTTP/HTTPS请求工具：支持自动重定向（3xx状态码）、超时控制（默认30秒）、错误捕获
- 密钥下载：自动下载加密片段所需密钥，保存至临时目录并缓存，避免重复下载
- 片段下载：
  - 多线程并发：通过`worker_threads`分配片段到工作线程，支持自定义线程数
  - 重试机制：超时或失败片段自动重试（支持自定义重试次数），无延迟立即重试
  - 状态标记：记录片段下载状态（已下载/未下载）、重试次数、错误信息

### 4. 加密与解密处理
- 解密支持：针对AES-128-CBC加密片段，使用`crypto.createDecipheriv`解密
- 密钥校验：确保密钥长度为16字节，IV缺失时使用默认空缓冲区（16字节0填充）
- 解密流程：下载片段后自动判断是否需要解密，解密后再保存文件

### 5. 断点续传与状态管理
- 临时目录：基于M3U8 URL的MD5哈希生成唯一临时目录（格式：`m3u8_cache_<10位哈希>`）
- 状态文件：在临时目录生成`download_state.json`，包含以下信息：
  - 基础信息：M3U8 URL、输出路径、最后合并索引、预估总大小
  - 片段状态：每个片段的索引、URL、下载状态、大小、密钥信息、重试次数
  - 统计数据：已下载数、总数、已下载大小、失败数、时间戳
- 状态保存：每隔3秒自动保存状态，异常退出前强制保存
- 状态加载：续传模式下加载状态文件，验证M3U8文件一致性（片段数不变）

### 6. 片段合并
- 合并策略：按片段索引顺序合并，支持增量合并（仅合并新增下载的片段）
- 文件处理：
  - 输出临时合并文件（`partial_output.ts`），最终重命名为目标文件
  - 支持强制合并（覆盖现有临时合并文件）
  - 跳过损坏文件（大小小于1KB的片段）
- 格式支持：默认输出MP4格式，支持通过参数指定扩展名

### 7. 进度监控与日志
- 实时进度条：长度50字符，显示进度百分比、已下载/总片段数、已下载大小/预估大小(已下载片段大小平均值*总个数)
- 速度统计：每秒更新当前下载速度（最近1秒下载量）和平均速度（总大小/总下载时间）
- 时间显示：已用时（格式：时:分:秒，不足1小时显示分:秒）
- 日志信息：下载重试提示、失败提示、合并进度、最终统计（大小、耗时、成功率）

### 8. 清理与退出
- 正常退出：合并完成后删除临时目录及文件
- 强制退出：异常时清除定时器，2秒后强制退出，确保资源释放
- 异常处理：捕获未处理的Promise拒绝和未捕获异常，保存状态后退出

## 四、工具函数需求
1. **路径处理**：
   - `getTempDirFromUrl`：基于URL生成临时目录路径
   - `getOutputFolder`：根据参数生成输出文件夹路径
   - `generateOutputFileName`：从URL提取或生成唯一文件名（含时间戳）
   - `getFullUrl`：将相对路径转换为完整URL
2. **格式化工具**：
   - `formatTime`：毫秒转换为时分秒格式
   - `formatSize`：字节转换为B/KB/MB/GB（保留2位小数）
   - `createProgressBar`：根据进度生成可视化进度条
3. **文件操作**：
   - `saveState/loadState`：保存/加载JSON格式状态文件
   - `checkDownloadedSegments`：检查临时目录中已下载的有效片段

## 五、异常处理与边界情况
1. 网络异常：请求超时、HTTP错误（非200状态码）、连接失败
2. 文件异常：状态文件缺失/损坏、片段文件损坏、权限不足
3. 数据一致性：M3U8文件变更（片段数变化）时禁止续传
4. 加密异常：密钥下载失败、解密密钥无效、IV格式错误

## 六、运行流程规范
1. 新下载流程：解析参数→创建临时目录→解析M3U8→下载密钥→检查已下载片段→动多线程下载→合并片段→清理临时文件→输出统计
2. 续传流程：解析参数→加载状态→验证M3U8→加载密钥→合并已下载片段→下载缺失片段→最终合并→清理→输出统计

## 七、交付标准
1. 完整可运行的Node.js脚本，文件名为`m3u8-downloader.js`
2. 支持Windows/macOS/Linux跨平台运行
3. 提供清晰的命令行使用说明，包含新下载和续传模式的示例命令
4. 异常场景下能正确保存状态，支持通过`--resume`参数恢复下载
5. 代码结构清晰，函数职责单一，包含必要的注释